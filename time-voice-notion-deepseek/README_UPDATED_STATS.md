# 统计功能更新说明

## 新增功能

### 1. 花销统计功能

#### API接口

**手动运行花销统计**
```http
POST /expense-stats/run-manual
```

手动触发一次花销统计，用于测试或即时查看统计结果。

**响应示例:**
```json
{
  "ok": true,
  "message": "手动花销统计任务已执行"
}
```

#### 调度配置
- **花销统计**: 每月1号00:05执行，统计上个月的数据

### 2. 本月时间统计功能

#### 更新后的手动统计API

**手动运行统计**
```http
POST /stats/run-manual
```

手动触发一次统计，用于测试或即时查看统计结果。

**请求体:**
```json
{
  "start_date": "2024-10-01",
  "end_date": "2024-10-31"
}
```

**响应示例:**
- 当指定日期范围时:
```json
{
  "ok": true,
  "message": "手动统计任务已执行（2024-10-01 到 2024-10-31）"
}
```

- 当日期范围为空时:
```json
{
  "ok": true,
  "message": "手动统计任务已执行（本月时间统计）"
}
```

**重要更新:** 如果 `start_date` 和 `end_date` 为空，现在会自动统计**本月的时间数据**，而不是昨天的数据。

#### 调度配置
- **时间统计**: 每天00:01执行，统计昨天的数据
- **花销统计**: 每月1号00:05执行，统计上个月的数据

## 报告格式

### 花销统计报告
```
💰 2025年10月 花销统计报告
==================================================
总条目数: 4
总金额: 275.5 元

📈 分类统计:
  娱乐: 120.00元 (43.6%)
  学习: 80.00元 (29.0%)
  餐饮: 50.00元 (18.1%)
  交通: 25.50元 (9.3%)

🏷️ 标签统计:
  #必要: 130.00元 (47.2%)
  #非必要: 120.00元 (43.6%)
  #日常: 75.50元 (27.4%)

📅 每日统计:
  2024-10-01: 50.00元
  2024-10-02: 25.50元
  2024-10-03: 80.00元
  2024-10-04: 120.00元

📝 详细花销 (前20条):
  10-01 | 50.00元 | 午餐
  10-02 | 25.50元 | 打车
  10-03 | 80.00元 | 买书
  10-04 | 120.00元 | 看电影
```

### 本月时间统计报告
```
📊 2024-10-01 到 2024-10-31 时间统计报告
==================================================
总条目数: 4
总时长: 8.0 小时
统计天数: 31 天

📈 分类统计:
  工作: 4.5h (56.2%)
  学习: 3.5h (43.8%)

🏷️ 标签统计:
  #开发: 3.0h (37.5%)
  #项目A: 3.0h (37.5%)
  #自我提升: 2.0h (25.0%)
  #会议: 1.5h (18.8%)
  #阅读: 1.5h (18.8%)

📅 每日统计:
  2024-10-01: 3.0h
  2024-10-02: 1.5h
  2024-10-03: 2.0h
  2024-10-04: 1.5h

📝 详细活动 (前20条):
  10-01 09:00-12:00 | 3.0h | 写代码
  10-02 14:00-15:30 | 1.5h | 开会
  10-03 19:00-21:00 | 2.0h | 学习新技术
  10-04 20:00-21:30 | 1.5h | 阅读
```

## 环境变量

需要配置以下环境变量：

- `NOTION_TOKEN`: Notion API token
- `NOTION_DATABASE_ID`: 时间记录的Notion数据库ID
- `NOTION_DATABASE_ID2`: 花销记录的Notion数据库ID
- `FEISHU_WEBHOOK_URL`: 飞书机器人webhook URL（可选）

## 测试

可以使用测试脚本验证功能：

```bash
# 测试花销统计功能
python test_expense_stats.py

# 测试本月时间统计功能
python test_current_month_stats.py
```

## 使用示例

### 手动触发花销统计
```bash
curl -X POST http://localhost:8000/expense-stats/run-manual
```

### 手动触发本月时间统计（不指定日期）
```bash
curl -X POST http://localhost:8000/stats/run-manual \
  -H "Content-Type: application/json" \
  -d '{}'
```

### 手动触发指定日期范围统计
```bash
curl -X POST http://localhost:8000/stats/run-manual \
  -H "Content-Type: application/json" \
  -d '{"start_date": "2024-10-01", "end_date": "2024-10-31"}'
```

### 启动统计调度器
```bash
curl -X POST http://localhost:8000/stats/start
```

### 停止统计调度器
```bash
curl -X POST http://localhost:8000/stats/stop
```

## 总结

本次更新主要包含：
1. **新增花销统计功能** - 支持按月统计花销数据
2. **优化手动统计API** - 当不指定日期范围时，自动统计本月时间数据
3. **完善调度系统** - 同时支持时间统计和花销统计的自动调度

所有新功能都保持了与现有API格式的一致性，便于使用和集成。
