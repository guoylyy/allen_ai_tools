# 花销统计功能说明

## 概述

本系统新增了花销统计功能，可以定期统计当月花销数据并通过飞书机器人发送报告。

## 功能特性

- **当月花销统计**: 每月1号自动统计上个月的花销数据
- **分类统计**: 按花销分类（餐饮、交通、购物等）进行统计
- **标签统计**: 按标签（日常、必要、非必要等）进行统计
- **每日统计**: 显示当月每日的花销情况
- **详细列表**: 显示详细的花销记录
- **飞书通知**: 通过飞书机器人发送统计报告

## API接口

### 手动运行花销统计

```http
POST /expense-stats/run-manual
```

手动触发一次花销统计，用于测试或即时查看统计结果。

**响应示例:**
```json
{
  "ok": true,
  "message": "手动花销统计任务已执行"
}
```

### 启动/停止统计调度器

```http
POST /stats/start
POST /stats/stop
```

启动或停止所有统计任务（包括时间统计和花销统计）。

## 调度配置

- **时间统计**: 每天00:01执行，统计昨天的数据
- **花销统计**: 每月1号00:05执行，统计上个月的数据

## 报告格式

花销统计报告包含以下内容：

```
💰 2025年10月 花销统计报告
==================================================
总条目数: 4
总金额: 275.5 元

📈 分类统计:
  娱乐: 120.00元 (43.6%)
  学习: 80.00元 (29.0%)
  餐饮: 50.00元 (18.1%)
  交通: 25.50元 (9.3%)

🏷️ 标签统计:
  #必要: 130.00元 (47.2%)
  #非必要: 120.00元 (43.6%)
  #日常: 75.50元 (27.4%)

📅 每日统计:
  2024-10-01: 50.00元
  2024-10-02: 25.50元
  2024-10-03: 80.00元
  2024-10-04: 120.00元

📝 详细花销 (前20条):
  10-01 | 50.00元 | 午餐
  10-02 | 25.50元 | 打车
  10-03 | 80.00元 | 买书
  10-04 | 120.00元 | 看电影
```

## 环境变量

需要配置以下环境变量：

- `NOTION_TOKEN`: Notion API token
- `NOTION_DATABASE_ID2`: 花销记录的Notion数据库ID
- `FEISHU_WEBHOOK_URL`: 飞书机器人webhook URL（可选）

## 测试

可以使用测试脚本验证功能：

```bash
python test_expense_stats.py
```

## 使用示例

### 手动触发花销统计

```bash
curl -X POST http://localhost:8000/expense-stats/run-manual
```

### 启动统计调度器

```bash
curl -X POST http://localhost:8000/stats/start
```

### 停止统计调度器

```bash
curl -X POST http://localhost:8000/stats/stop
